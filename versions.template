<head>
    <script src="https://code.jquery.com/jquery-3.6.2.slim.min.js" integrity="sha256-E3P3OaTZH+HlEM7f1gdAT3lHAn4nWBZXuYe89DFg2d0=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script type="text/javascript">
    $(function(){
        var updatedtime = $("#time").text();
        updatedtime = updatedtime.slice(updatedtime.indexOf(":") + 1).trim();
        var now = new Date();
        var lasttime = new Date(updatedtime);
        var gap = (now - lasttime)/(1000 * 3600);
        formData = new FormData();
        formData.append("name","username");
        formData.append("value","<DEFAULT>");
        formData.append("name","servers");
        formData.append("value","<DEFAULT>");
        formData.append("name","skips");
        formData.append("value","<DEFAULT>");
        formData.append("name","password");
        formData.append("value","<DEFAULT>");
        formData.append("name","confluence");
        formData.append("value","<DEFAULT>");
        formData.append("name","converts");
        formData.append("value","<DEFAULT>");
        formData.append("name","source");
        formData.append("value","<DEFAULT>");
        var path = location.href;
        if (path.endsWith("/")){
            path = path.substring(0,path.length-1);
        }
        job_url = path.substring(0,path.lastIndexOf("/"));

        if (gap < 3){
            $("#version").css("background-color","green");
        }else{
            if (gap < 24){
                $("#version").css("background-color","yellow");
            }else{
                $("#version").css("background-color","red");
            }
        }
        $("#loading").hide();
    });
    function getlastversion(){
        $.ajax({type:"GET",url:job_url+"/api/json",success:processData})
    }
    function processData(data,status,jqXHR){
        buildNo = data.lastBuild.number;
        successBuild = data.lastSuccessfulBuild.number;
        if (!buildNo == successBuild){
            $("#loading").show();
            $("#showversion").hide();
            setTimeOut(getlastversion,1000);
        }else{
            $("#loading").hide();
            $("#showversion").show();
        }
    }
    function buildjob(){
        var build_url = job_url+"build?";
        $.ajax({url:buil_url,enctype:'multipart/form-data',data:formData,
                success:function(data){
                    getlastversion();
                },
                error:function(err){
                    console.log(err);
                }
                }
                )

    }
    </script>

</head>
<body>

    <H1>Component Versions in QA Environments</H1>
    <div id="loading"><H3>Loading...</H3></div>
    <div id="showversion">
    <button id="version" onclick="buildjob()" class="btn btn-primary">Get The Latest Version</button>
    <b id="time">last updated: {{updatetime}}</b>
    </div>
    <Table border="1" style="width:100%">
    <TR>
    {% for field in components%}
           <th>{{field}}</th>
        {% endfor %}
    </TR>
         {% for envir in versions %}
         <TR >
         {% for component in components %}
              <TD style="background-color:{{envir|get_item:component|get_item:'color'}}" >{{envir|get_item:component|get_item:'value'}}</TD>
         {%endfor%}
         </TR>
         {% endfor %}
    </Table>
    <b>References:</b>
    <ul>
    {% for ref in references %}
        <li><a href='{{ref}}'>{{ref}}</a></li>
    {% endfor %}
    </ul>
</body>